# k8s/deployment.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-ml-deployment
  labels:
    app: ml-api
spec:
  replicas: 2 # Bonne pratique MLOps : deux instances pour la haute disponibilit√©
  selector:
    matchLabels:
      app: ml-api
  template:
    metadata:
      labels:
        app: ml-api
    spec:
      # K8s doit s'authentifier aupr√®s de GHCR.
      # Si vous utilisez un K8s manag√© (GKE, EKS, AKS), des configurations sp√©cifiques
      # pour le Pull Secret (imagePullSecrets) seraient n√©cessaires ici.
      containers:
      - name: ml-api-container
        # üö® Mettez votre chemin complet ici : ghcr.io/<votre-user>/<votre-repo>:<sha-tag>
        image: ghcr.io/CodeWithSagomb/fastapi-mlops-project:latest
        imagePullPolicy: Always 
        ports:
        - containerPort: 8000
        resources:
          limits: # D√©finition des limites (essentiel pour la stabilit√© du cluster)
            memory: "512Mi"
            cpu: "500m" # 0.5 CPU core
        
        # Probes : Crucial pour K8s pour g√©rer le trafic et les red√©marrages
        livenessProbe: # Est-ce que le conteneur doit √™tre red√©marr√© ?
          httpGet:
            path: /health # Utiliser notre route de sant√©
            port: 8000
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe: # Est-ce que le conteneur est pr√™t √† recevoir du trafic ?
          httpGet:
            path: /health
            port: 8000
          periodSeconds: 5